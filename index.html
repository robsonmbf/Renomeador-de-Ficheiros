<!DOCTYPE html>
<html lang="pt-BR" class=""> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renomeador e Validador eSocial (S-2220 / S-2240)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .drop-zone-active {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        .dark .drop-zone-active {
            border-color: #60a5fa; /* blue-400 */
            background-color: #1e293b; /* slate-800 */
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
            background-color: #1e293b; /* slate-800 */
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
        }
        [data-tooltip] {
            position: relative;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
            border: 2px solid #f1f5f9; /* slate-100 */
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-color: #1e293b; /* slate-800 */
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 min-h-screen p-4 sm:p-6 lg:p-8 transition-colors duration-300">

    <div class="w-full max-w-7xl mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 md:p-8 relative">
        
        <div class="absolute top-4 right-4 z-10">
            <button id="theme-toggle" class="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-slate-800 transition">
                <i id="theme-toggle-dark-icon" class="fas fa-moon text-lg hidden"></i>
                <i id="theme-toggle-light-icon" class="fas fa-sun text-lg hidden"></i>
            </button>
        </div>

        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500 dark:from-blue-400 dark:to-cyan-300 pb-2">
                Renomeador e Validador eSocial
            </h1>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Automatize a renomeação e valide os recibos dos eventos S-2220 e S-2240.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 lg:gap-10">

            <div class="lg:col-span-3 space-y-8">
                
                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 border-t-4 border-t-blue-500 shadow-sm">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <label for="empresa" class="block text-lg font-semibold text-slate-700 dark:text-slate-300">
                                <span class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-3">1</span>Selecione a Empresa
                            </label>
                            <button id="manage-companies-btn" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold">
                                <i class="fas fa-cog mr-1"></i>Gerir
                            </button>
                        </div>
                        <select id="empresa" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="" disabled selected>Escolha uma opção...</option>
                        </select>
                        <div id="manual-cnpj-container" class="mt-4 hidden">
                            <label for="manual-cnpj-input" class="block text-sm font-medium text-slate-600 dark:text-slate-400">Informe o CNPJ (apenas números)</label>
                            <input type="text" id="manual-cnpj-input" maxlength="14" class="mt-1 w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Digite os 14 dígitos do CNPJ">
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 border-t-4 border-t-blue-500 shadow-sm">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <label for="naming-pattern-select" class="block text-lg font-semibold text-slate-700 dark:text-slate-300">
                                <span class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-3">2</span>Selecione o Padrão
                            </label>
                            <button id="manage-patterns-btn" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold">
                                <i class="fas fa-edit mr-1"></i>Gerir
                            </button>
                        </div>
                        <select id="naming-pattern-select" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></select>
                        <div class="mt-3">
                            <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Pré-visualização:</p>
                            <p id="pattern-preview" class="text-sm text-slate-800 dark:text-slate-200 bg-slate-100 dark:bg-slate-900/50 p-3 rounded-lg font-mono border border-slate-200 dark:border-slate-700 truncate"></p>
                        </div>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Placeholders: [prefixo], [cnpj], [data], [cpf], [matricula]</p>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 border-t-4 border-t-blue-500 shadow-sm">
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-300">
                                    <span class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-3">3</span>Ficheiros de Evento (Originais)
                                </h2>
                                <label for="file-input" id="drop-zone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-4 text-center cursor-pointer transition hover:bg-slate-50 dark:hover:bg-slate-700/50 w-full flex items-center justify-center gap-3">
                                    <i class="fas fa-file-code text-2xl text-blue-500 dark:text-blue-400"></i>
                                    <span class="text-slate-600 dark:text-slate-300 font-semibold">Carregar Ficheiros XML</span>
                                </label>
                                <input type="file" id="file-input" multiple accept=".xml" class="hidden">
                            </div>
                            <div class="space-y-2">
                                 <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-300">
                                    <span class="bg-slate-500 text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-3">4</span>Planilha (Opcional)
                                </h2>
                                <label for="spreadsheet-input" id="spreadsheet-drop-zone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-4 text-center cursor-pointer transition hover:bg-slate-50 dark:hover:bg-slate-700/50 w-full flex items-center justify-center gap-3">
                                     <i class="fas fa-file-excel text-2xl text-green-500 dark:text-green-400"></i>
                                     <span id="spreadsheet-status" class="text-slate-600 dark:text-slate-300 font-semibold">Carregar Planilha</span>
                                </label>
                                 <input type="file" id="spreadsheet-input" accept=".xls, .xlsx" class="hidden">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 border-t-4 border-t-green-500 shadow-sm">
                    <div class="p-6">
                        <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-4">
                            <i class="fas fa-check-double text-green-500 mr-2"></i>Confirmação de Envio (Ficheiros com Recibo)
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="confirmation-month" class="block text-sm font-medium text-slate-600 dark:text-slate-400">Mês de Referência</label>
                                <select id="confirmation-month" class="mt-1 w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"></select>
                            </div>
                            <div>
                                <label for="confirmation-year" class="block text-sm font-medium text-slate-600 dark:text-slate-400">Ano</label>
                                <input type="number" id="confirmation-year" class="mt-1 w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                            </div>
                            <div class="md:col-span-3">
                                <label for="confirmation-input" id="confirmation-drop-zone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-4 text-center cursor-pointer transition hover:bg-slate-50 dark:hover:bg-slate-700/50 w-full flex items-center justify-center gap-3">
                                    <i class="fas fa-file-invoice text-2xl text-green-500 dark:text-green-400"></i>
                                    <span class="text-slate-600 dark:text-slate-300 font-semibold">Carregar Ficheiros com Recibo</span>
                                </label>
                                <input type="file" id="confirmation-input" multiple accept=".xml" class="hidden">
                            </div>
                        </div>
                        <div id="confirmation-list-container" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-2 mb-4">
                             <div id="no-confirmation-message" class="text-center text-slate-500 dark:text-slate-400 py-5">
                                <i class="fas fa-receipt text-2xl mb-2"></i>
                                <p class="text-sm">Os resultados da validação aparecerão aqui.</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                             <button id="generate-proof-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                <i class="fas fa-print"></i>Gerar Comprovante
                            </button>
                             <button id="clear-confirmations-btn" class="bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-200 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                <i class="fas fa-trash-alt"></i>Limpar Lista
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="lg:col-span-2 mt-8 lg:mt-0 flex flex-col">
                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 border-t-4 border-t-blue-500 shadow-sm p-6 mb-6">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700 dark:text-slate-300"><span class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-3">5</span>Ações Finais</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="download-zip-btn" class="bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <i class="fas fa-file-archive"></i>.zip
                        </button>
                         <button id="download-individual-btn" class="bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-cyan-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <i class="fas fa-download"></i>Individuais
                        </button>
                        <button id="download-report-btn" class="bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <i class="fas fa-file-alt"></i>Relatório
                        </button>
                        <button id="clear-list-btn" class="bg-rose-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-rose-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <i class="fas fa-trash"></i>Limpar
                        </button>
                    </div>
                    <div class="mt-4 flex items-center justify-center">
                        <input type="checkbox" id="organize-folders-checkbox" class="h-4 w-4 rounded border-slate-300 dark:border-slate-500 text-indigo-600 focus:ring-indigo-500" checked>
                        <label for="organize-folders-checkbox" class="ml-2 block text-sm text-slate-700 dark:text-slate-300">Organizar .zip em subpastas</label>
                    </div>
                </div>

                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700 flex-grow flex flex-col min-h-0">
                    <h3 class="text-xl font-semibold p-6 pb-4 text-slate-800 dark:text-white flex-shrink-0">Resultados do Processamento</h3>
                    <div class="flex-grow min-h-0 overflow-y-auto custom-scrollbar px-6 pb-6">
                        <div id="file-list-container" class="hidden space-y-6">
                             <div id="s2220-section" class="hidden">
                                 <h3 class="text-lg font-semibold mb-3 text-cyan-700 dark:text-cyan-400">Evento S-2220 (<span id="s2220-count">0</span>)</h3>
                                 <div id="s2220-list" class="space-y-2"></div>
                             </div>
                             <div id="s2240-section" class="hidden">
                                 <h3 class="text-lg font-semibold mb-3 text-teal-700 dark:text-teal-400">Evento S-2240 (<span id="s2240-count">0</span>)</h3>
                                 <div id="s2240-list" class="space-y-2"></div>
                             </div>
                             <div id="error-section" class="hidden">
                                 <h3 class="text-lg font-semibold mb-3 text-rose-500 dark:text-rose-400">Ficheiros com Erro (<span id="error-count">0</span>)</h3>
                                 <div id="error-list" class="space-y-2"></div>
                             </div>
                        </div>

                        <div id="processed-summary-container" class="mt-6 hidden">
                            <h3 class="text-lg font-semibold mb-3 text-slate-800 dark:text-white">Resumo de Ficheiros Processados</h3>
                            <div id="processed-summary-list" class="space-y-2"></div>
                        </div>

                        <div id="employee-status-container" class="mt-4 hidden">
                             <h3 class="text-lg font-semibold mb-3 text-slate-800 dark:text-white">Status de Envio (Planilha)</h3>
                             <div id="employee-status-list" class="space-y-2"></div>
                        </div>

                        <div id="no-files-message" class="text-center text-slate-500 dark:text-slate-400 py-10 h-full flex flex-col justify-center items-center">
                            <i class="fas fa-list-alt text-4xl mb-4"></i>
                            <p>Os seus ficheiros processados aparecerão aqui.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-6 max-w-sm w-full text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/50">
                <i class="fas fa-times text-2xl text-red-600 dark:text-red-400"></i>
            </div>
            <h3 class="text-lg leading-6 font-medium text-slate-900 dark:text-white mt-4" id="error-title">Erro</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-slate-500 dark:text-slate-400" id="error-message">Ocorreu um erro.</p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="close-error-modal-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <div id="companies-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Gerir Empresas</h3>
            <form id="add-company-form" class="space-y-4 mb-6">
                <div>
                    <label for="company-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nome da Empresa</label>
                    <input type="text" id="company-name" placeholder="Ex: Minha Empresa (0001-00)" required class="mt-1 w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700">
                </div>
                <div>
                    <label for="company-cnpj" class="block text-sm font-medium text-slate-700 dark:text-slate-300">CNPJ (apenas números)</label>
                    <input type="text" id="company-cnpj" placeholder="12345678000100" maxlength="14" required class="mt-1 w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Empresa</button>
            </form>
            <div id="company-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div>
            <div class="mt-6 text-right">
                <button id="close-companies-modal-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-medium rounded-md hover:bg-slate-300 dark:hover:bg-slate-500">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <div id="patterns-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Gerir Padrões de Nomenclatura</h3>
            <form id="add-pattern-form" class="space-y-4 mb-6">
                <div>
                    <label for="pattern-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nome do Padrão</label>
                    <input type="text" id="pattern-name" placeholder="Ex: Padrão SOC" required class="mt-1 w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700">
                </div>
                <div>
                    <label for="pattern-value" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Padrão</label>
                    <input type="text" id="pattern-value" placeholder="[prefixo]_[cnpj]_[data]_[cpf]_[matricula]" required class="mt-1 w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Padrão</button>
            </form>
            <div id="pattern-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div>
            <div class="mt-6 text-right">
                <button id="close-patterns-modal-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-medium rounded-md hover:bg-slate-300 dark:hover:bg-slate-500">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <div id="manual-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-3xl transform transition-all">
            <div class="text-center">
                <i class="fas fa-rocket text-4xl text-blue-500 dark:text-blue-400"></i>
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white mt-4 mb-2">Bem-vindo ao Renomeador e Validador!</h2>
                <p class="text-slate-600 dark:text-slate-400 mb-8">Esta ferramenta foi criada para simplificar a sua vida, renomeando ficheiros e validando os recibos de envio dos eventos S-2220 e S-2240 do eSocial.</p>
            </div>
            
            <div class="text-left space-y-5 text-slate-700 dark:text-slate-300">
                <h3 class="text-lg font-semibold border-b border-slate-200 dark:border-slate-700 pb-2">Como Usar (Guia Rápido):</h3>
                <ol class="list-decimal list-inside space-y-4">
                    <li>
                        <strong>Analisar e Renomear:</strong> Use os passos de 1 a 4 para selecionar a empresa, padrão, carregar os **ficheiros de evento originais** e (opcionalmente) uma planilha de referência para ver os nomes dos funcionários.
                    </li>
                    <li>
                        <strong>Descarregar:</strong> Use os botões na coluna da direita para descarregar os ficheiros renomeados ou gerar um **Relatório** completo em Excel.
                    </li>
                     <li>
                        <strong>Validar Recibos:</strong> Após o envio ao eSocial, use a seção de **Confirmação de Envio**. Selecione o mês de referência, carregue os **ficheiros com recibo** para validar as datas e gerar um **Comprovante**.
                    </li>
                </ol>
            </div>

            <div class="mt-10 text-center">
                <button id="close-manual-modal-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-slate-800 transition-transform hover:scale-105">
                    Entendi, vamos começar!
                </button>
            </div>
        </div>
    </div>

    <script>
       document.addEventListener('DOMContentLoaded', () => {

        // --- Seletores de Elementos DOM (Renomeador) ---
        const empresaSelect = document.getElementById('empresa');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const downloadZipBtn = document.getElementById('download-zip-btn');
        const downloadIndividualBtn = document.getElementById('download-individual-btn');
        const downloadReportBtn = document.getElementById('download-report-btn');
        const clearListBtn = document.getElementById('clear-list-btn');
        const fileListContainer = document.getElementById('file-list-container');
        const noFilesMessage = document.getElementById('no-files-message');
        const organizeFoldersCheckbox = document.getElementById('organize-folders-checkbox');
        const namingPatternSelect = document.getElementById('naming-pattern-select');
        const manualCnpjContainer = document.getElementById('manual-cnpj-container');
        const manualCnpjInput = document.getElementById('manual-cnpj-input');
        const patternPreview = document.getElementById('pattern-preview');
        const spreadsheetInput = document.getElementById('spreadsheet-input');
        const spreadsheetStatus = document.getElementById('spreadsheet-status');
        const spreadsheetDropZone = document.getElementById('spreadsheet-drop-zone');
        const employeeStatusContainer = document.getElementById('employee-status-container');
        const employeeStatusList = document.getElementById('employee-status-list');
        const processedSummaryContainer = document.getElementById('processed-summary-container');
        const processedSummaryList = document.getElementById('processed-summary-list');

        // --- Lógica da Seção de Confirmação ---
        const confirmationMonthSelect = document.getElementById('confirmation-month');
        const confirmationYearInput = document.getElementById('confirmation-year');
        const confirmationDropZone = document.getElementById('confirmation-drop-zone');
        const confirmationInput = document.getElementById('confirmation-input');
        const confirmationListContainer = document.getElementById('confirmation-list-container');
        const noConfirmationMessage = document.getElementById('no-confirmation-message');
        const clearConfirmationsBtn = document.getElementById('clear-confirmations-btn');
        const generateProofBtn = document.getElementById('generate-proof-btn');


        // --- Seletores de Modais ---
        const errorModal = {
            el: document.getElementById('error-modal'),
            title: document.getElementById('error-title'),
            message: document.getElementById('error-message'),
            closeBtn: document.getElementById('close-error-modal-btn')
        };
        const companiesModal = {
            el: document.getElementById('companies-modal'),
            openBtn: document.getElementById('manage-companies-btn'),
            closeBtn: document.getElementById('close-companies-modal-btn'),
            form: document.getElementById('add-company-form'),
            list: document.getElementById('company-list'),
            nameInput: document.getElementById('company-name'),
            cnpjInput: document.getElementById('company-cnpj')
        };
        const patternsModal = {
            el: document.getElementById('patterns-modal'),
            openBtn: document.getElementById('manage-patterns-btn'),
            closeBtn: document.getElementById('close-patterns-modal-btn'),
            form: document.getElementById('add-pattern-form'),
            list: document.getElementById('pattern-list'),
            nameInput: document.getElementById('pattern-name'),
            valueInput: document.getElementById('pattern-value')
        };
        const manualModal = {
            el: document.getElementById('manual-modal'),
            closeBtn: document.getElementById('close-manual-modal-btn')
        };

        // --- Lógica do Manual de Boas-Vindas ---
        if (!localStorage.getItem('esocialRenamerManualSeen')) {
            manualModal.el.classList.remove('hidden');
            manualModal.el.classList.add('flex');
        }

        manualModal.closeBtn.addEventListener('click', () => {
            manualModal.el.classList.add('hidden');
            manualModal.el.classList.remove('flex');
            localStorage.setItem('esocialRenamerManualSeen', 'true');
        });

        // --- Seletores Dark Mode ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        // --- Estado da Aplicação ---
        let processedFiles = [];
        let confirmationFiles = [];
        let companies = [];
        let namingPatterns = [];
        let socEmployeesData = new Map();
        
        // --- Lógica do Modo Escuro ---
        const applyTheme = () => {
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        };

        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
            applyTheme();
        });
        
        // --- Lógica de Gerenciamento de Empresas ---
        const saveCompanies = () => localStorage.setItem('esocial_renamer_companies', JSON.stringify(companies));

        const loadCompanies = () => {
            const stored = localStorage.getItem('esocial_renamer_companies');
            companies = stored ? JSON.parse(stored) : [
                { name: "Fundo de Promoções Coletivas do Shopping RioMar (0001-23)", cnpj: "16416670000123" },
                { name: "Mobilidade Recife Parking Ltda (0001-00)", cnpj: "15768762000100" },
                { name: "Subcondomínio Riomar Recife (0001-70)", cnpj: "16888022000170" }
            ];
            renderCompanyUI();
        };

        const renderCompanyUI = () => {
            empresaSelect.innerHTML = '<option value="" disabled selected>Escolha uma opção...</option>';
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.cnpj;
                option.textContent = company.name;
                empresaSelect.appendChild(option);
            });
            
            const manualOption = document.createElement('option');
            manualOption.value = 'manual';
            manualOption.textContent = '--- Informar CNPJ manualmente ---';
            empresaSelect.appendChild(manualOption);

            companiesModal.list.innerHTML = '';
            companies.forEach((company, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-slate-100 dark:bg-slate-700 p-2 rounded';
                div.innerHTML = `
                    <span class="text-sm">${company.name}</span>
                    <button data-index="${index}" class="delete-company-btn text-rose-500 hover:text-rose-700"><i class="fas fa-trash"></i></button>`;
                companiesModal.list.appendChild(div);
            });
        };

        empresaSelect.addEventListener('change', () => {
            manualCnpjContainer.classList.toggle('hidden', empresaSelect.value !== 'manual');
        });

        // --- Lógica dos Modais (CORRIGIDA) ---
        companiesModal.openBtn.addEventListener('click', () => {
            companiesModal.el.classList.remove('hidden');
            companiesModal.el.classList.add('flex');
        });
        companiesModal.closeBtn.addEventListener('click', () => {
            companiesModal.el.classList.add('hidden');
            companiesModal.el.classList.remove('flex');
        });
        
        patternsModal.openBtn.addEventListener('click', () => {
            patternsModal.el.classList.remove('hidden');
            patternsModal.el.classList.add('flex');
        });
        patternsModal.closeBtn.addEventListener('click', () => {
            patternsModal.el.classList.add('hidden');
            patternsModal.el.classList.remove('flex');
        });

        companiesModal.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = companiesModal.nameInput.value.trim();
            const cnpj = companiesModal.cnpjInput.value.trim().replace(/\D/g, '');
            if (name && cnpj.length === 14) {
                companies.push({ name, cnpj });
                saveCompanies();
                renderCompanyUI();
                companiesModal.form.reset();
            } else {
                showError('Dados Inválidos', 'Preencha o nome e um CNPJ válido com 14 dígitos.');
            }
        });
        companiesModal.list.addEventListener('click', (e) => {
            if (e.target.closest('.delete-company-btn')) {
                const index = e.target.closest('.delete-company-btn').dataset.index;
                companies.splice(index, 1);
                saveCompanies();
                renderCompanyUI();
            }
        });

        const savePatterns = () => localStorage.setItem('esocial_renamer_patterns', JSON.stringify(namingPatterns));

        const loadPatterns = () => {
            const stored = localStorage.getItem('esocial_renamer_patterns');
            namingPatterns = stored ? JSON.parse(stored) : [
                { name: "Envio Grupo Rio Mar", value: "[prefixo]_[cnpj]_[data]_[cpf]_[matricula]" },
                { name: "Padrão SOC (Alternativo)", value: "[prefixo]-[cnpj]-[cpf]-[matricula]" },
                { name: "Invertido (Matrícula Primeiro)", value: "[matricula]_[cpf]_[prefixo]_[cnpj]_[data]" }
            ];
            renderPatternUI();
        };

        const renderPatternUI = () => {
            namingPatternSelect.innerHTML = '';
            namingPatterns.forEach(pattern => {
                const option = document.createElement('option');
                option.value = pattern.value;
                option.textContent = pattern.name;
                namingPatternSelect.appendChild(option);
            });

            patternsModal.list.innerHTML = '';
            namingPatterns.forEach((pattern, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-slate-100 dark:bg-slate-700 p-2 rounded';
                div.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold">${pattern.name}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">${pattern.value}</p>
                    </div>
                    <button data-index="${index}" class="delete-pattern-btn text-rose-500 hover:text-rose-700"><i class="fas fa-trash"></i></button>`;
                patternsModal.list.appendChild(div);
            });
            updatePatternPreview();
        };
        
        function updatePatternPreview() {
            patternPreview.textContent = namingPatternSelect.value ? namingPatternSelect.value : "Crie ou selecione um padrão acima.";
        }
        
        namingPatternSelect.addEventListener('change', updatePatternPreview);

        patternsModal.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = patternsModal.nameInput.value.trim();
            const value = patternsModal.valueInput.value.trim();
            if (name && value) {
                namingPatterns.push({ name, value });
                savePatterns();
                renderPatternUI();
                patternsModal.form.reset();
            } else {
                showError('Dados Inválidos', 'Preencha o nome e o valor do padrão.');
            }
        });
        patternsModal.list.addEventListener('click', (e) => {
            if (e.target.closest('.delete-pattern-btn')) {
                const index = e.target.closest('.delete-pattern-btn').dataset.index;
                namingPatterns.splice(index, 1);
                savePatterns();
                renderPatternUI();
            }
        });

        spreadsheetInput.addEventListener('change', (e) => handleSpreadsheet(e.target.files[0]));
        spreadsheetDropZone.addEventListener('click', () => spreadsheetInput.click());
        spreadsheetDropZone.addEventListener('dragover', (e) => { e.preventDefault(); spreadsheetDropZone.classList.add('drop-zone-active'); });
        spreadsheetDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); spreadsheetDropZone.classList.remove('drop-zone-active'); });
        spreadsheetDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            spreadsheetDropZone.classList.remove('drop-zone-active');
            if (e.dataTransfer.files.length > 0) {
                handleSpreadsheet(e.dataTransfer.files[0]);
            }
        });

        function handleSpreadsheet(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    socEmployeesData.clear();
                    let cpfColumnIndex = -1;
                    let nameColumnIndex = -1;
                    let headerRowIndex = -1;

                    if (json.length > 0) {
                        for (let i = 0; i < Math.min(10, json.length); i++) {
                            const headers = json[i].map(h => String(h).trim().toUpperCase());
                            const tempCpfIndex = headers.indexOf('CPF');
                            const tempNameIndex = headers.indexOf('NOME FUNCIONÁRIO');
                            
                            if (tempCpfIndex !== -1 && tempNameIndex !== -1) {
                                cpfColumnIndex = tempCpfIndex;
                                nameColumnIndex = tempNameIndex;
                                headerRowIndex = i;
                                break;
                            }
                        }
                    }

                    if (cpfColumnIndex === -1 || nameColumnIndex === -1) {
                        showError('Colunas não encontradas', 'Não foi possível encontrar as colunas "CPF" e "NOME FUNCIONÁRIO" na planilha.');
                        spreadsheetStatus.textContent = 'Erro ao ler planilha.';
                        return;
                    }

                    for (let i = headerRowIndex + 1; i < json.length; i++) {
                        const row = json[i];
                        if (row && row[cpfColumnIndex] && row[nameColumnIndex]) {
                            const cpf = String(row[cpfColumnIndex]).replace(/\D/g, '').padStart(11, '0');
                            const name = String(row[nameColumnIndex]);
                            socEmployeesData.set(cpf, { name, hasS2220: false, hasS2240: false });
                        }
                    }
                    
                    spreadsheetStatus.textContent = `${socEmployeesData.size} funcionários carregados.`;
                    
                    if (processedFiles.length > 0) {
                         processedFiles.forEach(file => {
                            if (!file.error && socEmployeesData.has(file.cpf)) {
                                const employee = socEmployeesData.get(file.cpf);
                                if (file.eventType === 'S-2220') employee.hasS2220 = true;
                                if (file.eventType === 'S-2240') employee.hasS2240 = true;
                            }
                        });
                    }

                    updateEmployeeStatusUI();
                    updateFileListUI();
                    updateProcessedSummaryUI();
                } catch (err) {
                    showError('Erro ao ler planilha', `Ocorreu um erro: ${err.message}`);
                    spreadsheetStatus.textContent = 'Erro ao ler planilha.';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function validaCPF(cpf) {
            cpf = String(cpf).replace(/[^\d]+/g, '');
            if (cpf === '' || cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            let soma = 0, resto;
            for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
            resto = (soma * 10) % 11;
            if ((resto === 10) || (resto === 11)) resto = 0;
            if (resto !== parseInt(cpf.substring(9, 10))) return false;
            soma = 0;
            for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
            resto = (soma * 10) % 11;
            if ((resto === 10) || (resto === 11)) resto = 0;
            if (resto !== parseInt(cpf.substring(10, 11))) return false;
            return true;
        }
        
        function checkForDuplicates(files) {
            const seenEvents = new Map();
            files.forEach(file => file.isDuplicate = false);

            files.forEach(file => {
                if (file.error || !file.cpf || file.cpf === 'SEM_CPF') return;
                
                const key = `${file.cpf}-${file.eventType}`;
                if (seenEvents.has(key)) {
                    const originalFile = seenEvents.get(key);
                    originalFile.isDuplicate = true;
                    file.isDuplicate = true;
                } else {
                    seenEvents.set(key, file);
                }
            });
            return files;
        }

        function validateCrossFileData(files) {
            const filesByCpf = {};
            files.forEach(file => {
                if (!file.error && file.cpf !== 'SEM_CPF') {
                    if (!filesByCpf[file.cpf]) filesByCpf[file.cpf] = [];
                    filesByCpf[file.cpf].push(file);
                }
            });

            for (const cpf in filesByCpf) {
                const group = filesByCpf[cpf];
                if (group.length > 1) {
                    const firstMatricula = group[0].matricula;
                    const isConsistent = group.every(file => file.matricula === firstMatricula);
                    if (!isConsistent) {
                        group.forEach(file => file.hasInconsistency = true);
                    }
                }
            }
            return files;
        }

        function showError(title, message) {
            errorModal.el.classList.remove('hidden');
            errorModal.el.classList.add('flex');
            errorModal.title.textContent = title;
            errorModal.message.textContent = message;
        }

        function closeErrorModal() {
            errorModal.el.classList.add('hidden');
            errorModal.el.classList.remove('flex');
        }

        function updateFileListUI() {
            if (processedFiles.length === 0) {
                fileListContainer.classList.add('hidden');
                noFilesMessage.classList.remove('hidden');
                updateButtonStates();
                return;
            }
            fileListContainer.classList.remove('hidden');
            noFilesMessage.classList.add('hidden');

            const s2220List = document.getElementById('s2220-list');
            const s2240List = document.getElementById('s2240-list');
            const errorList = document.getElementById('error-list');
            const s2220Count = document.getElementById('s2220-count');
            const s2240Count = document.getElementById('s2240-count');
            const errorCount = document.getElementById('error-count');
            const s2220Section = document.getElementById('s2220-section');
            const s2240Section = document.getElementById('s2240-section');
            const errorSection = document.getElementById('error-section');

            s2220List.innerHTML = '';
            s2240List.innerHTML = '';
            errorList.innerHTML = '';

            const s2220Files = processedFiles.filter(f => f.eventType === 'S-2220' && !f.error);
            const s2240Files = processedFiles.filter(f => f.eventType === 'S-2240' && !f.error);
            const filesWithErrors = processedFiles.filter(f => f.error);

            s2220Count.textContent = s2220Files.length;
            s2240Count.textContent = s2240Files.length;
            errorCount.textContent = filesWithErrors.length;

            s2220Section.classList.toggle('hidden', s2220Files.length === 0);
            s2240Section.classList.toggle('hidden', s2240Files.length === 0);
            errorSection.classList.toggle('hidden', filesWithErrors.length === 0);

            const createFileItem = (fileData) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'bg-white dark:bg-slate-700/50 p-3 rounded-lg flex items-center justify-between border border-slate-200 dark:border-slate-600/50 shadow-sm hover:shadow-md transition-shadow duration-200';
                let statusIcon, statusColor, newNameHtml, actionButton, cpfWarningHtml = '', inconsistencyWarningHtml = '', socStatusHtml = '', duplicateWarningHtml = '';
                
                if (fileData.error) {
                    statusIcon = 'fas fa-exclamation-triangle'; statusColor = 'text-rose-500';
                    newNameHtml = `<p class="text-xs text-rose-500 font-medium">${fileData.error}</p>`; actionButton = '';
                } else {
                    statusIcon = 'fas fa-check-circle'; statusColor = 'text-emerald-500';
                    newNameHtml = `<div class="flex items-center flex-wrap"><p class="text-xs font-semibold text-slate-800 dark:text-slate-100">${fileData.newName}</p></div>`;
                    actionButton = `<a href="${URL.createObjectURL(fileData.newBlob)}" download="${fileData.newName}" class="ml-4 text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition flex-shrink-0" data-tooltip="Baixar ficheiro"><i class="fas fa-download"></i></a>`;
                    if (!fileData.isCpfValid) {
                        cpfWarningHtml = `<span class="ml-2" data-tooltip="CPF inválido"><i class="fas fa-exclamation-triangle text-amber-500"></i></span>`;
                    }
                    if (fileData.hasInconsistency) {
                        inconsistencyWarningHtml = `<span class="ml-2" data-tooltip="Inconsistência: Matrícula diferente para este CPF em outro ficheiro."><i class="fas fa-exclamation-circle text-orange-500"></i></span>`;
                    }
                    if (fileData.isDuplicate) {
                        duplicateWarningHtml = `<span class="ml-2" data-tooltip="Duplicidade: Já existe um evento ${fileData.eventType} para este CPF na lista."><i class="fas fa-copy text-yellow-500"></i></span>`;
                    }
                    if (socEmployeesData.size > 0 && socEmployeesData.has(fileData.cpf)) {
                        socStatusHtml = `<span class="ml-2" data-tooltip="Funcionário encontrado na planilha SOC."><i class="fas fa-check-double text-sky-500"></i></span>`;
                    }
                }

                fileItem.innerHTML = `
                    <div class="flex items-center gap-3 flex-grow min-w-0">
                        <i class="${statusIcon} ${statusColor} text-xl"></i>
                        <div class="flex-grow min-w-0">
                            <p class="font-medium text-sm truncate" title="${fileData.originalName}">${fileData.originalName}</p> 
                            <div class="flex items-center">
                                ${newNameHtml}
                                ${cpfWarningHtml}
                                ${inconsistencyWarningHtml}
                                ${duplicateWarningHtml}
                                ${socStatusHtml}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 ml-2">${actionButton}</div>`;
                return fileItem;
            };

            s2220Files.forEach(fileData => s2220List.appendChild(createFileItem(fileData)));
            s2240Files.forEach(fileData => s2240List.appendChild(createFileItem(fileData)));
            filesWithErrors.forEach(fileData => errorList.appendChild(createFileItem(fileData)));
            updateButtonStates();
        }
        
        function updateProcessedSummaryUI() {
            const validFiles = processedFiles.filter(f => !f.error && f.cpf !== 'SEM_CPF');

            if (validFiles.length === 0) {
                processedSummaryContainer.classList.add('hidden');
                return;
            }

            const summary = new Map();
            validFiles.forEach(file => {
                if (!summary.has(file.cpf)) {
                    const employeeName = socEmployeesData.has(file.cpf) 
                        ? socEmployeesData.get(file.cpf).name 
                        : `CPF: ${file.cpf}`;
                    summary.set(file.cpf, { name: employeeName, events: new Set() });
                }
                summary.get(file.cpf).events.add(file.eventType);
            });

            processedSummaryList.innerHTML = '';
            summary.forEach((data, cpf) => {
                const item = document.createElement('div');
                item.className = 'bg-white dark:bg-slate-700/50 p-3 rounded-lg flex items-center justify-between border border-slate-200 dark:border-slate-600/50 shadow-sm';

                const s2220Icon = data.events.has('S-2220')
                    ? `<i class="fas fa-check-circle text-cyan-500"></i>`
                    : `<i class="fas fa-times-circle text-slate-400"></i>`;
                
                const s2240Icon = data.events.has('S-2240')
                    ? `<i class="fas fa-check-circle text-teal-500"></i>`
                    : `<i class="fas fa-times-circle text-slate-400"></i>`;

                item.innerHTML = `
                    <p class="font-medium text-sm flex-grow truncate" title="${data.name}">${data.name}</p>
                    <div class="flex items-center gap-4 text-xs font-semibold flex-shrink-0 ml-2">
                        <span class="flex items-center gap-2" data-tooltip="S-2220"> ${s2220Icon}</span>
                        <span class="flex items-center gap-2" data-tooltip="S-2240"> ${s2240Icon}</span>
                    </div>
                `;
                processedSummaryList.appendChild(item);
            });

            processedSummaryContainer.classList.remove('hidden');
        }

        function updateEmployeeStatusUI() {
            const employeesWithFiles = Array.from(socEmployeesData.values()).filter(data => data.hasS2220 || data.hasS2240);

            if (employeesWithFiles.length === 0) {
                employeeStatusContainer.classList.add('hidden');
                return;
            }
            employeeStatusContainer.classList.remove('hidden');
            employeeStatusList.innerHTML = '';

            employeesWithFiles.forEach(data => {
                const item = document.createElement('div');
                item.className = 'bg-white dark:bg-slate-700/50 p-3 rounded-lg flex items-center justify-between border border-slate-200 dark:border-slate-600/50 shadow-sm';

                const s2220Icon = data.hasS2220 
                    ? `<i class="fas fa-check-circle text-emerald-500"></i>`
                    : `<i class="fas fa-times-circle text-slate-400"></i>`;
                
                const s2240Icon = data.hasS2240
                    ? `<i class="fas fa-check-circle text-emerald-500"></i>`
                    : `<i class="fas fa-times-circle text-slate-400"></i>`;

                item.innerHTML = `
                    <p class="font-medium text-sm flex-grow truncate" title="${data.name}">${data.name}</p>
                    <div class="flex items-center gap-4 text-xs font-semibold flex-shrink-0 ml-2">
                        <span class="flex items-center gap-2" data-tooltip="S-2220"> ${s2220Icon}</span>
                        <span class="flex items-center gap-2" data-tooltip="S-2240"> ${s2240Icon}</span>
                    </div>
                `;
                employeeStatusList.appendChild(item);
            });
        }

        function updateButtonStates() {
            const hasProcessedFiles = processedFiles.some(f => !f.error);
            const hasAnyFiles = processedFiles.length > 0;
            downloadZipBtn.disabled = !hasProcessedFiles;
            downloadIndividualBtn.disabled = !hasProcessedFiles;
            downloadReportBtn.disabled = !hasAnyFiles;
            clearListBtn.disabled = !hasAnyFiles;
        }

        errorModal.closeBtn.addEventListener('click', closeErrorModal);
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drop-zone-active'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drop-zone-active'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-zone-active');
            handleFiles(e.dataTransfer.files);
        });
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        async function handleFiles(files) {
            let cnpjCompleto, companyName;
            if (empresaSelect.value === 'manual') {
                cnpjCompleto = manualCnpjInput.value.trim().replace(/\D/g, '');
                if (cnpjCompleto.length !== 14) {
                    showError('CNPJ Inválido', 'Por favor, informe um CNPJ com 14 dígitos.'); return;
                }
                companyName = `CNPJ Manual (${cnpjCompleto})`;
            } else {
                if (!empresaSelect.value) {
                    showError('Seleção Necessária', 'Por favor, escolha uma empresa ou informe o CNPJ manualmente.');
                    fileInput.value = ''; return;
                }
                const selectedOption = empresaSelect.options[empresaSelect.selectedIndex];
                companyName = selectedOption.text;
                cnpjCompleto = selectedOption.value;
            }
            if (!namingPatternSelect.value) {
                showError('Padrão não selecionado', 'Por favor, crie ou selecione um padrão de nomenclatura.');
                fileInput.value = ''; return;
            }
            const newFiles = Array.from(files).filter(file => file.type === 'text/xml' || file.name.endsWith('.xml'));
            if (newFiles.length === 0) {
                showError('Ficheiro Inválido', 'Por favor, selecione apenas ficheiros .xml.'); return;
            }
            const processingPromises = newFiles.map(file => processFile({ file: file, originalName: file.name }, cnpjCompleto, companyName));
            let results = await Promise.all(processingPromises);
            
            processedFiles = [...processedFiles, ...results];
            processedFiles = validateCrossFileData(processedFiles);
            processedFiles = checkForDuplicates(processedFiles);

            if (socEmployeesData.size > 0) {
                socEmployeesData.forEach(employee => {
                    employee.hasS2220 = false;
                    employee.hasS2240 = false;
                });

                processedFiles.forEach(file => {
                    if (!file.error && socEmployeesData.has(file.cpf)) {
                        const employee = socEmployeesData.get(file.cpf);
                        if (file.eventType === 'S-2220') employee.hasS2220 = true;
                        if (file.eventType === 'S-2240') employee.hasS2240 = true;
                    }
                });
            }

            updateFileListUI();
            updateEmployeeStatusUI();
            updateProcessedSummaryUI();
            fileInput.value = '';
        }

        async function processFile(fileData, cnpj, companyName) {
            try {
                const xmlText = await fileData.file.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                const parserError = xmlDoc.querySelector("parsererror");
                if (parserError) return { ...fileData, error: "XML mal formatado." };
                const getText = (selector) => xmlDoc.querySelector(selector)?.textContent || null;
                const eventNode = xmlDoc.querySelector('[Id]');
                if (!eventNode) return { ...fileData, error: "Tag de evento com 'Id' não encontrada." };
                const idEvento = eventNode.getAttribute('Id');
                const cpf = (getText("cpfTrab") || "SEM_CPF").replace(/\D/g, '').padStart(11, '0');
                const isCpfValid = validaCPF(cpf);
                const matricula = getText("matricula") || "SEM_MATRICULA";
                const dtAdm = getText("dtAdm") || "N/A"; // NOVO: Captura a data de admissão
                const dataHora = idEvento.substring(17, 31);
                let prefixo = "DESCONHECIDO", eventType = "DESCONHECIDO";
                const nomeDoEvento = eventNode.localName;
                if (nomeDoEvento === "evtMonit") { prefixo = "MST"; eventType = "S-2220"; }
                else if (["evtCondAmb", "evtExpRisco"].includes(nomeDoEvento)) { prefixo = "COND_AMB_TRAB"; eventType = "S-2240"; }
                const pattern = namingPatternSelect.value;
                const novoNome = pattern
                    .replace(/\[prefixo\]/g, prefixo).replace(/\[cnpj\]/g, cnpj)
                    .replace(/\[data\]/g, dataHora).replace(/\[cpf\]/g, cpf)
                    .replace(/\[matricula\]/g, matricula) + '.xml';
                const newBlob = new Blob([xmlText], { type: 'text/xml' });
                return { ...fileData, newName: novoNome, newBlob, companyName, eventType, cpf, isCpfValid, matricula, dtAdm }; // NOVO: Retorna dtAdm
            } catch (e) {
                console.error("Erro detalhado:", fileData.originalName, e);
                return { ...fileData, error: `Erro: ${e.message}` };
            }
        }

        function saveFile(blob, filename) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        downloadZipBtn.addEventListener('click', () => {
            const zip = new JSZip();
            const validFiles = processedFiles.filter(f => f.newBlob && !f.error);
            if (validFiles.length === 0) return;
            const organizeInFolders = organizeFoldersCheckbox.checked;
            validFiles.forEach(fileData => {
                let path = '';
                if (organizeInFolders) {
                    const companyFullName = fileData.companyName;
                    const firstName = companyFullName.split(' ')[0];
                    const cnpjEnding = companyFullName.match(/\(([^)]+)\)/)?.[1] || '';
                    path += `${firstName} ${cnpjEnding}`.trim() + '/';
                    path += fileData.eventType + '/';
                }
                zip.file(path + fileData.newName, fileData.newBlob);
            });
            zip.generateAsync({ type: "blob" }).then(content => {
                saveFile(content, `eSocial_Renomeados_${Date.now()}.zip`);
            });
        });

        downloadIndividualBtn.addEventListener('click', () => {
            const validFiles = processedFiles.filter(f => f.newBlob && !f.error);
            if (validFiles.length === 0) return;
            validFiles.forEach((fileData, index) => {
                setTimeout(() => {
                    saveFile(fileData.newBlob, fileData.newName);
                }, index * 200);
            });
        });
        
        downloadReportBtn.addEventListener('click', () => {
            const wb = XLSX.utils.book_new();

            if (processedFiles.length > 0) {
                const reportData = processedFiles.map(file => ({
                    "Nome Original": file.originalName,
                    "Novo Nome": file.newName || 'N/A',
                    "Status": file.error ? `ERRO: ${file.error}` : 'Sucesso',
                    "CPF": file.cpf || 'N/A',
                    "Status CPF": file.error ? 'N/A' : (file.isCpfValid ? 'Válido' : 'Inválido'),
                    "Matricula": file.matricula || 'N/A',
                    "Data de Admissão": file.dtAdm || 'N/A', // NOVO: Adiciona a data de admissão ao relatório
                    "Tipo de Evento": file.eventType || 'N/A',
                    "Inconsistência": file.hasInconsistency ? 'Matrícula divergente' : 'N/A',
                    "Duplicidade": file.isDuplicate ? 'Sim' : 'Não',
                    "Encontrado na Planilha": socEmployeesData.has(file.cpf) ? 'Sim' : 'Não'
                }));
                const ws1 = XLSX.utils.json_to_sheet(reportData);
                XLSX.utils.book_append_sheet(wb, ws1, "Relatório de Ficheiros");
            }

            const employeesWithFiles = Array.from(socEmployeesData.entries())
                .filter(([cpf, data]) => data.hasS2220 || data.hasS2240)
                .map(([cpf, data]) => ({
                    "Nome Funcionário": data.name,
                    "CPF": cpf,
                    "Envio S-2220": data.hasS2220 ? "Sim" : "Não",
                    "Envio S-2240": data.hasS2240 ? "Sim" : "Não"
                }));

            if (employeesWithFiles.length > 0) {
                const ws2 = XLSX.utils.json_to_sheet(employeesWithFiles);
                XLSX.utils.book_append_sheet(wb, ws2, "Status de Envios por Funcionário");
            }
            
            if (wb.SheetNames.length > 0) {
                XLSX.writeFile(wb, `Relatorio_eSocial_${Date.now()}.xlsx`);
            } else {
                showError('Nenhum dado para exportar', 'Processe alguns ficheiros ou carregue uma planilha com funcionários correspondentes.');
            }
        });

        clearListBtn.addEventListener('click', () => {
            processedFiles = [];
            socEmployeesData.clear();
            spreadsheetStatus.textContent = 'Carregar Planilha';
            spreadsheetInput.value = '';
            updateFileListUI();
            updateEmployeeStatusUI();
            updateProcessedSummaryUI();
        });

        // --- Lógica para Gerar Comprovante de Confirmação ---
        function generateConfirmationProof() {
            if (confirmationFiles.length === 0) {
                showError('Nenhum dado', 'Não há ficheiros validados para gerar um comprovante.');
                return;
            }

            const companyName = empresaSelect.options[empresaSelect.selectedIndex]?.text || "Empresa não selecionada";
            const referenceMonth = confirmationMonthSelect.options[confirmationMonthSelect.selectedIndex].text;
            const referenceYear = confirmationYearInput.value;
            const generationDate = new Date().toLocaleString('pt-BR');

            let tableRows = '';
            confirmationFiles.forEach(file => {
                let statusText, statusColor;
                const employeeIdentifier = socEmployeesData.has(file.cpf) ? socEmployeesData.get(file.cpf).name : `CPF: ${file.cpf}`;

                if (file.error) {
                    statusText = `Erro: ${file.error}`;
                    statusColor = '#dc2626'; // Red
                } else if (file.status === 'confirmed') {
                    statusText = 'Confirmado';
                    statusColor = '#16a34a'; // Green
                } else {
                    statusText = `Mês Divergente (Recibo de ${file.receiptMonth})`;
                    statusColor = '#f59e0b'; // Amber
                }

                tableRows += `
                    <tr>
                        <td>${employeeIdentifier}</td>
                        <td>${file.originalName}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                    </tr>
                `;
            });

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>Comprovante de Validação de Recibos eSocial</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        h1 { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .header { margin-bottom: 30px; border-bottom: 2px solid #ccc; padding-bottom: 15px; }
                        p { color: #555; }
                        @media print {
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Comprovante de Validação de Recibos eSocial</h1>
                        <p><strong>Empresa:</strong> ${companyName}</p>
                        <p><strong>Mês de Referência para Validação:</strong> ${referenceMonth} de ${referenceYear}</p>
                        <p><strong>Data de Geração:</strong> ${generationDate}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Funcionário</th>
                                <th>Ficheiro do Recibo</th>
                                <th>Status da Validação</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; cursor: pointer;">Imprimir</button>
                </body>
                </html>
            `;
            
            const proofWindow = window.open('', '_blank');
            proofWindow.document.write(htmlContent);
            proofWindow.document.close();
        }

        // --- INICIALIZAÇÃO E LÓGICA DA SEÇÃO DE CONFIRMAÇÃO ---
        function setupConfirmationSection() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = (index + 1).toString().padStart(2, '0');
                option.textContent = month;
                if (index === currentMonth) {
                    option.selected = true;
                }
                confirmationMonthSelect.appendChild(option);
            });
            confirmationYearInput.value = currentYear;

            confirmationDropZone.addEventListener('click', () => confirmationInput.click());
            confirmationInput.addEventListener('change', (e) => handleConfirmationFiles(e.target.files));
            confirmationDropZone.addEventListener('dragover', (e) => { e.preventDefault(); confirmationDropZone.classList.add('drop-zone-active'); });
            confirmationDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); confirmationDropZone.classList.remove('drop-zone-active'); });
            confirmationDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                confirmationDropZone.classList.remove('drop-zone-active');
                handleConfirmationFiles(e.dataTransfer.files);
            });
            clearConfirmationsBtn.addEventListener('click', () => {
                confirmationFiles = [];
                updateConfirmationListUI();
            });
            generateProofBtn.addEventListener('click', generateConfirmationProof);
        }
        
        async function handleConfirmationFiles(files) {
            const referenceYear = confirmationYearInput.value;
            const referenceMonth = confirmationMonthSelect.value;
            if (!referenceYear || !referenceMonth) {
                showError('Data de Referência Incompleta', 'Por favor, selecione o mês e o ano de referência para a validação.');
                return;
            }
            const referenceYYYYMM = `${referenceYear}${referenceMonth}`;

            const newFiles = Array.from(files).filter(file => file.type === 'text/xml' || file.name.endsWith('.xml'));
            const processingPromises = newFiles.map(file => processConfirmationFile(file, referenceYYYYMM));
            const results = await Promise.all(processingPromises);

            confirmationFiles.push(...results);
            updateConfirmationListUI();
            confirmationInput.value = '';
        }

        async function processConfirmationFile(file, referenceYYYYMM) {
            try {
                const xmlText = await file.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                
                const nrReciboNode = xmlDoc.querySelector("nrRecibo");

                if (!nrReciboNode) {
                    return { originalName: file.name, error: "Recibo não encontrado no ficheiro." };
                }

                // Tenta encontrar o CPF em múltiplos locais para ser mais robusto
                const cpfTrabNode = xmlDoc.querySelector("cpfTrab") || xmlDoc.querySelector("cpf");
                const nrRecibo = nrReciboNode.textContent;
                const cpfTrab = cpfTrabNode ? cpfTrabNode.textContent.replace(/\D/g, '').padStart(11, '0') : "SEM_CPF";
                
                // Formato do recibo: 1.2.YYYYMMDDHHMMSSNNNNN
                const receiptYYYYMM = nrRecibo.substring(4, 10);
                
                const status = receiptYYYYMM === referenceYYYYMM ? 'confirmed' : 'mismatched';
                
                return { originalName: file.name, cpf: cpfTrab, status, receiptMonth: `${receiptYYYYMM.substring(4,6)}/${receiptYYYYMM.substring(0,4)}` };

            } catch(e) {
                return { originalName: file.name, error: `Erro de leitura: ${e.message}` };
            }
        }

        function updateConfirmationListUI() {
            const hasFiles = confirmationFiles.length > 0;
            noConfirmationMessage.classList.toggle('hidden', hasFiles);
            clearConfirmationsBtn.disabled = !hasFiles;
            generateProofBtn.disabled = !hasFiles;
            
            const itemsToRemove = confirmationListContainer.querySelectorAll('.confirmation-item');
            itemsToRemove.forEach(item => item.remove());

            confirmationFiles.forEach(file => {
                const div = document.createElement('div');
                div.className = 'p-2 rounded-md flex items-center justify-between text-sm confirmation-item';
                let icon, color, message;

                const employeeIdentifier = socEmployeesData.has(file.cpf) ? socEmployeesData.get(file.cpf).name : `CPF: ${file.cpf}`;

                if (file.error) {
                    icon = 'fas fa-times-circle';
                    color = 'text-rose-500 dark:text-rose-400';
                    message = `<span class="font-semibold">${file.error}</span>`;
                    div.classList.add('bg-rose-50', 'dark:bg-rose-900/50');
                } else if (file.status === 'confirmed') {
                    icon = 'fas fa-check-circle';
                    color = 'text-emerald-600 dark:text-emerald-400';
                    message = `Confirmado para <strong>${confirmationMonthSelect.options[confirmationMonthSelect.selectedIndex].text}</strong>. (${employeeIdentifier})`;
                     div.classList.add('bg-emerald-50', 'dark:bg-emerald-900/50');
                } else { // mismatched
                    icon = 'fas fa-exclamation-triangle';
                    color = 'text-amber-600 dark:text-amber-400';
                    message = `Atenção: Recibo de <strong>${file.receiptMonth}</strong>. (${employeeIdentifier})`;
                    div.classList.add('bg-amber-50', 'dark:bg-amber-900/50');
                }

                div.innerHTML = `
                    <div class="flex items-center gap-3 min-w-0">
                        <i class="${icon} ${color}"></i>
                        <div class="truncate">
                            <p class="truncate" title="${file.originalName}">${file.originalName}</p>
                            <p class="text-xs text-slate-600 dark:text-slate-400">${message}</p>
                        </div>
                    </div>
                `;
                confirmationListContainer.insertBefore(div, noConfirmationMessage);
            });
        }
        
        // --- INICIALIZAÇÃO GERAL ---
        applyTheme();
        loadCompanies();
        loadPatterns();
        updateButtonStates();
        setupConfirmationSection();
    });
    </script>
</body>
</html>
