<!DOCTYPE html>
<html lang="pt-BR" class=""> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renomeador e Validador eSocial (S-2220 / S-2240)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .drop-zone-active {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        .dark .drop-zone-active {
            border-color: #60a5fa; /* blue-400 */
            background-color: #1e293b; /* slate-800 */
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
            background-color: #1e293b; /* slate-800 */
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
        }
        [data-tooltip] {
            position: relative;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
            border: 2px solid #f1f5f9; /* slate-100 */
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-color: #1e293b; /* slate-800 */
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 min-h-screen p-4 sm:p-6 lg:p-8 transition-colors duration-300">

    <div class="w-full max-w-7xl mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 md:p-8 relative">
        
        <div class="absolute top-4 right-4 z-10">
            <button id="theme-toggle" class="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-slate-800 transition">
                <i id="theme-toggle-dark-icon" class="fas fa-moon text-lg hidden"></i>
                <i id="theme-toggle-light-icon" class="fas fa-sun text-lg hidden"></i>
            </button>
        </div>

        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500 dark:from-blue-400 dark:to-cyan-300 pb-2">
                Renomeador e Validador eSocial
            </h1>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Automatize a renomeação e valide os recibos dos eventos S-2220 e S-2240.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 lg:gap-10">

            <div class="lg:col-span-3 space-y-8">
                
                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 border-t-4 border-t-blue-500 shadow-sm">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <label for="empresa" class="block text-lg font-semibold text-slate-700 dark:text-slate-300">
                                <span class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-3">1</span>Selecione a Empresa
                            </label>
                            <button id="manage-companies-btn" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold">
                                <i class="fas fa-cog mr-1"></i>Gerir
                            </button>
                        </div>
                        <select id="empresa" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="" disabled selected>Escolha uma opção...</option>
                        </select>
                        <div id="manual-cnpj-container" class="mt-4 hidden">
                            <label for="manual-cnpj-input" class="block text-sm font-medium text-slate-600 dark:text-slate-400">Informe o CNPJ (apenas números)</label>
                            <input type="text" id="manual-cnpj-input" maxlength="14" class="mt-1 w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Digite os 14 dígitos do CNPJ">
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 border-t-4 border-t-blue-500 shadow-sm">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <label for="naming-pattern-select" class="block text-lg font-semibold text-slate-700 dark:text-slate-300">
                                <span class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-3">2</span>Selecione o Padrão
                            </label>
                            <button id="manage-patterns-btn" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold">
                                <i class="fas fa-edit mr-1"></i>Gerir
                            </button>
                        </div>
                        <select id="naming-pattern-select" class="w-full p-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></select>
                        <div class="mt-3">
                            <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1">Pré-visualização:</p>
                            <p id="pattern-preview" class="text-sm text-slate-800 dark:text-slate-200 bg-slate-100 dark:bg-slate-900/50 p-3 rounded-lg font-mono border border-slate-200 dark:border-slate-700 truncate"></p>
                        </div>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Placeholders: [prefixo], [cnpj], [data], [cpf], [matricula]</p>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 border-t-4 border-t-blue-500 shadow-sm">
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-300">
                                    <span class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-3">3</span>Ficheiros XML
                                </h2>
                                <label for="file-input" id="drop-zone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-4 text-center cursor-pointer transition hover:bg-slate-50 dark:hover:bg-slate-700/50 w-full flex items-center justify-center gap-3">
                                    <i class="fas fa-file-code text-2xl text-blue-500 dark:text-blue-400"></i>
                                    <span class="text-slate-600 dark:text-slate-300 font-semibold">Carregar Ficheiros XML</span>
                                </label>
                                <input type="file" id="file-input" multiple accept=".xml" class="hidden">
                            </div>
                            <div class="space-y-2">
                                 <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-300">
                                    <span class="bg-slate-500 text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-3">4</span>Planilha (Opcional)
                                </h2>
                                <label for="spreadsheet-input" id="spreadsheet-drop-zone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-4 text-center cursor-pointer transition hover:bg-slate-50 dark:hover:bg-slate-700/50 w-full flex items-center justify-center gap-3">
                                     <i class="fas fa-file-excel text-2xl text-green-500 dark:text-green-400"></i>
                                     <span id="spreadsheet-status" class="text-slate-600 dark:text-slate-300 font-semibold">Carregar Planilha</span>
                                </label>
                                 <input type="file" id="spreadsheet-input" accept=".xls, .xlsx" class="hidden">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 border-t-4 border-t-green-500 shadow-sm">
                    <div class="p-6">
                        <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-4">
                            <i class="fas fa-check-double text-green-500 mr-2"></i>Confirmação de Envio
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="confirmation-month" class="block text-sm font-medium text-slate-600 dark:text-slate-400">Mês de Referência</label>
                                <select id="confirmation-month" class="mt-1 w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"></select>
                            </div>
                            <div>
                                <label for="confirmation-year" class="block text-sm font-medium text-slate-600 dark:text-slate-400">Ano</label>
                                <input type="number" id="confirmation-year" class="mt-1 w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                            </div>
                            <div class="md:col-span-3">
                                <label for="confirmation-input" id="confirmation-drop-zone" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-4 text-center cursor-pointer transition hover:bg-slate-50 dark:hover:bg-slate-700/50 w-full flex items-center justify-center gap-3">
                                    <i class="fas fa-file-invoice text-2xl text-green-500 dark:text-green-400"></i>
                                    <span class="text-slate-600 dark:text-slate-300 font-semibold">Carregar Ficheiros com Recibo</span>
                                </label>
                                <input type="file" id="confirmation-input" multiple accept=".xml" class="hidden">
                            </div>
                        </div>
                        <div id="confirmation-list-container" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-2 mb-4">
                             <div id="no-confirmation-message" class="text-center text-slate-500 dark:text-slate-400 py-5">
                                <i class="fas fa-receipt text-2xl mb-2"></i>
                                <p class="text-sm">Os resultados da validação aparecerão aqui.</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="generate-proof-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                <i class="fas fa-print"></i>Gerar Comprovante
                            </button>
                             <button id="clear-confirmations-btn" class="bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-200 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                <i class="fas fa-trash-alt"></i>Limpar Lista
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="lg:col-span-2 mt-8 lg:mt-0 flex flex-col">
                <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 border-t-4 border-t-blue-500 shadow-sm p-6 mb-6">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700 dark:text-slate-300"><span class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-full w-8 h-8 inline-flex items-center justify-center mr-3">5</span>Ações Finais</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="download-zip-btn" class="bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <i class="fas fa-file-archive"></i>.zip
                        </button>
                         <button id="download-individual-btn" class="bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-cyan-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <i class="fas fa-download"></i>Individuais
                        </button>
                        <button id="download-report-btn" class="bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <i class="fas fa-file-alt"></i>Relatório
                        </button>
                        <button id="clear-list-btn" class="bg-rose-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-rose-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <i class="fas fa-trash"></i>Limpar
                        </button>
                    </div>
                    <div class="mt-4 flex items-center justify-center">
                        <input type="checkbox" id="organize-folders-checkbox" class="h-4 w-4 rounded border-slate-300 dark:border-slate-500 text-indigo-600 focus:ring-indigo-500" checked>
                        <label for="organize-folders-checkbox" class="ml-2 block text-sm text-slate-700 dark:text-slate-300">Organizar .zip em subpastas</label>
                    </div>
                </div>

                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700 flex-grow flex flex-col min-h-0">
                    <h3 class="text-xl font-semibold p-6 pb-4 text-slate-800 dark:text-white flex-shrink-0">Resultados do Processamento</h3>
                    <div class="flex-grow min-h-0 overflow-y-auto custom-scrollbar px-6 pb-6">
                        <div id="file-list-container" class="hidden space-y-6">
                             <div id="s2220-section" class="hidden">
                                 <h3 class="text-lg font-semibold mb-3 text-cyan-700 dark:text-cyan-400">Evento S-2220 (<span id="s2220-count">0</span>)</h3>
                                 <div id="s2220-list" class="space-y-2"></div>
                             </div>
                             <div id="s2240-section" class="hidden">
                                 <h3 class="text-lg font-semibold mb-3 text-teal-700 dark:text-teal-400">Evento S-2240 (<span id="s2240-count">0</span>)</h3>
                                 <div id="s2240-list" class="space-y-2"></div>
                             </div>
                             <div id="error-section" class="hidden">
                                 <h3 class="text-lg font-semibold mb-3 text-rose-500 dark:text-rose-400">Ficheiros com Erro (<span id="error-count">0</span>)</h3>
                                 <div id="error-list" class="space-y-2"></div>
                             </div>
                        </div>

                        <div id="processed-summary-container" class="mt-6 hidden">
                            <h3 class="text-lg font-semibold mb-3 text-slate-800 dark:text-white">Resumo de Ficheiros Processados</h3>
                            <div id="processed-summary-list" class="space-y-2"></div>
                        </div>

                        <div id="employee-status-container" class="mt-4 hidden">
                             <h3 class="text-lg font-semibold mb-3 text-slate-800 dark:text-white">Status de Envio (Planilha)</h3>
                             <div id="employee-status-list" class="space-y-2"></div>
                        </div>

                        <div id="no-files-message" class="text-center text-slate-500 dark:text-slate-400 py-10 h-full flex flex-col justify-center items-center">
                            <i class="fas fa-list-alt text-4xl mb-4"></i>
                            <p>Os seus ficheiros processados aparecerão aqui.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">...</div>
    <div id="companies-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">...</div>
    <div id="patterns-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">...</div>
    <div id="manual-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">...</div>

    <script>
       document.addEventListener('DOMContentLoaded', () => {

        // --- Seletores de Elementos DOM (Renomeador) ---
        const empresaSelect = document.getElementById('empresa');
        // ... (demais seletores da seção principal)

        // --- Lógica da Seção de Confirmação ---
        const confirmationMonthSelect = document.getElementById('confirmation-month');
        const confirmationYearInput = document.getElementById('confirmation-year');
        const confirmationDropZone = document.getElementById('confirmation-drop-zone');
        const confirmationInput = document.getElementById('confirmation-input');
        const confirmationListContainer = document.getElementById('confirmation-list-container');
        const noConfirmationMessage = document.getElementById('no-confirmation-message');
        const clearConfirmationsBtn = document.getElementById('clear-confirmations-btn');
        const generateProofBtn = document.getElementById('generate-proof-btn'); // NOVO


        // --- Seletores de Modais ---
        // ... (seletores de modais)

        // --- Lógica do Manual de Boas-Vindas ---
        // ... (lógica do manual)

        // --- Estado da Aplicação ---
        let processedFiles = [];
        let confirmationFiles = [];
        let companies = [];
        let namingPatterns = [];
        let socEmployeesData = new Map();
        
        // --- Lógica do Modo Escuro ---
        // ... (lógica do modo escuro)
        
        // --- Lógica de Gerenciamento de Empresas e Padrões ---
        // ... (funções de gerir empresas e padrões)

        // --- Funções Principais do Renomeador ---
        // ... (toda a lógica do renomeador, handleFiles, processFile, etc.)

        // --- Lógica para Gerar Comprovante de Confirmação ---
        function generateConfirmationProof() {
            if (confirmationFiles.length === 0) {
                showError('Nenhum dado', 'Não há ficheiros validados para gerar um comprovante.');
                return;
            }

            const companyName = empresaSelect.options[empresaSelect.selectedIndex]?.text || "Empresa não selecionada";
            const referenceMonth = confirmationMonthSelect.options[confirmationMonthSelect.selectedIndex].text;
            const referenceYear = confirmationYearInput.value;
            const generationDate = new Date().toLocaleString('pt-BR');

            let tableRows = '';
            confirmationFiles.forEach(file => {
                let statusText, statusColor;
                const employeeIdentifier = socEmployeesData.get(file.cpf)?.name || `CPF: ${file.cpf}`;

                if (file.error) {
                    statusText = `Erro: ${file.error}`;
                    statusColor = '#dc2626'; // Red
                } else if (file.status === 'confirmed') {
                    statusText = 'Confirmado';
                    statusColor = '#16a34a'; // Green
                } else {
                    statusText = `Mês Divergente (Recibo de ${file.receiptMonth})`;
                    statusColor = '#f59e0b'; // Amber
                }

                tableRows += `
                    <tr>
                        <td>${employeeIdentifier}</td>
                        <td>${file.originalName}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                    </tr>
                `;
            });

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>Comprovante de Validação de Recibos eSocial</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        h1 { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .header { margin-bottom: 30px; border-bottom: 2px solid #ccc; padding-bottom: 15px; }
                        p { color: #555; }
                        @media print {
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Comprovante de Validação de Recibos eSocial</h1>
                        <p><strong>Empresa:</strong> ${companyName}</p>
                        <p><strong>Mês de Referência para Validação:</strong> ${referenceMonth} de ${referenceYear}</p>
                        <p><strong>Data de Geração:</strong> ${generationDate}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Funcionário</th>
                                <th>Ficheiro do Recibo</th>
                                <th>Status da Validação</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; cursor: pointer;">Imprimir</button>
                </body>
                </html>
            `;
            
            const proofWindow = window.open('', '_blank');
            proofWindow.document.write(htmlContent);
            proofWindow.document.close();
        }

        // --- INICIALIZAÇÃO E LÓGICA DA SEÇÃO DE CONFIRMAÇÃO ---
        function setupConfirmationSection() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = (index + 1).toString().padStart(2, '0');
                option.textContent = month;
                if (index === currentMonth) {
                    option.selected = true;
                }
                confirmationMonthSelect.appendChild(option);
            });
            confirmationYearInput.value = currentYear;

            confirmationDropZone.addEventListener('click', () => confirmationInput.click());
            confirmationInput.addEventListener('change', (e) => handleConfirmationFiles(e.target.files));
            confirmationDropZone.addEventListener('dragover', (e) => { e.preventDefault(); confirmationDropZone.classList.add('drop-zone-active'); });
            confirmationDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); confirmationDropZone.classList.remove('drop-zone-active'); });
            confirmationDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                confirmationDropZone.classList.remove('drop-zone-active');
                handleConfirmationFiles(e.dataTransfer.files);
            });
            clearConfirmationsBtn.addEventListener('click', () => {
                confirmationFiles = [];
                updateConfirmationListUI();
            });
            generateProofBtn.addEventListener('click', generateConfirmationProof); // NOVO
        }
        
        async function handleConfirmationFiles(files) {
            const referenceYear = confirmationYearInput.value;
            const referenceMonth = confirmationMonthSelect.value;
            if (!referenceYear || !referenceMonth) {
                showError('Data de Referência Incompleta', 'Por favor, selecione o mês e o ano de referência para a validação.');
                return;
            }
            const referenceYYYYMM = `${referenceYear}${referenceMonth}`;

            const newFiles = Array.from(files).filter(file => file.type === 'text/xml' || file.name.endsWith('.xml'));
            const processingPromises = newFiles.map(file => processConfirmationFile(file, referenceYYYYMM));
            const results = await Promise.all(processingPromises);

            confirmationFiles.push(...results);
            updateConfirmationListUI();
            confirmationInput.value = '';
        }

        async function processConfirmationFile(file, referenceYYYYMM) {
            try {
                const xmlText = await file.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                
                const nrReciboNode = xmlDoc.querySelector("nrRecibo");
                const cpfTrabNode = xmlDoc.querySelector("cpfTrab");

                if (!nrReciboNode) {
                    return { originalName: file.name, error: "Recibo não encontrado no ficheiro." };
                }
                const nrRecibo = nrReciboNode.textContent;
                const cpfTrab = cpfTrabNode ? cpfTrabNode.textContent.replace(/\D/g, '').padStart(11, '0') : "SEM_CPF";
                
                // Formato do recibo: 1.2.YYYYMMDDHHMMSSNNNNN
                const receiptYYYYMM = nrRecibo.substring(4, 10);
                
                const status = receiptYYYYMM === referenceYYYYMM ? 'confirmed' : 'mismatched';
                
                return { originalName: file.name, cpf: cpfTrab, status, receiptMonth: `${receiptYYYYMM.substring(4,6)}/${receiptYYYYMM.substring(0,4)}` };

            } catch(e) {
                return { originalName: file.name, error: `Erro de leitura: ${e.message}` };
            }
        }

        function updateConfirmationListUI() {
            const hasFiles = confirmationFiles.length > 0;
            noConfirmationMessage.classList.toggle('hidden', hasFiles);
            clearConfirmationsBtn.disabled = !hasFiles;
            generateProofBtn.disabled = !hasFiles; // NOVO
            
            // Limpa a lista antes de recriar
            const itemsToRemove = confirmationListContainer.querySelectorAll('.confirmation-item');
            itemsToRemove.forEach(item => item.remove());


            confirmationFiles.forEach(file => {
                const div = document.createElement('div');
                div.className = 'p-2 rounded-md flex items-center justify-between text-sm confirmation-item'; // Adicionada classe
                let icon, color, message;

                const employeeIdentifier = socEmployeesData.get(file.cpf)?.name || `CPF: ${file.cpf}`;

                if (file.error) {
                    icon = 'fas fa-times-circle';
                    color = 'text-rose-500 dark:text-rose-400';
                    message = `<span class="font-semibold">${file.error}</span>`;
                    div.classList.add('bg-rose-50', 'dark:bg-rose-900/50');
                } else if (file.status === 'confirmed') {
                    icon = 'fas fa-check-circle';
                    color = 'text-emerald-600 dark:text-emerald-400';
                    message = `Confirmado para <strong>${confirmationMonthSelect.options[confirmationMonthSelect.selectedIndex].text}</strong>. (${employeeIdentifier})`;
                     div.classList.add('bg-emerald-50', 'dark:bg-emerald-900/50');
                } else { // mismatched
                    icon = 'fas fa-exclamation-triangle';
                    color = 'text-amber-600 dark:text-amber-400';
                    message = `Atenção: Recibo de <strong>${file.receiptMonth}</strong>. (${employeeIdentifier})`;
                    div.classList.add('bg-amber-50', 'dark:bg-amber-900/50');
                }

                div.innerHTML = `
                    <div class="flex items-center gap-3 min-w-0">
                        <i class="${icon} ${color}"></i>
                        <div class="truncate">
                            <p class="truncate" title="${file.originalName}">${file.originalName}</p>
                            <p class="text-xs text-slate-600 dark:text-slate-400">${message}</p>
                        </div>
                    </div>
                `;
                confirmationListContainer.insertBefore(div, noConfirmationMessage);
            });
        }
        
        // --- INICIALIZAÇÃO GERAL ---
        // (É necessário o corpo das funções omitidas para que a aplicação funcione)
        // ... cole aqui as funções omitidas do seu script anterior ...
        
        applyTheme();
        loadCompanies();
        loadPatterns();
        updateButtonStates();
        setupConfirmationSection(); // Inicializa a nova seção
    });
    </script>
</body>
</html>
